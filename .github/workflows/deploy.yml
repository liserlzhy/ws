name: Build documentation

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  INSTANCE: Writerside/hi
  ARTIFACT: webHelpHI2-all.zip
  DOCKER_VERSION: 232.10165.1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Writerside
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: ${{ env.INSTANCE }}
          artifact: ${{ env.ARTIFACT }}
          docker-version: ${{ env.DOCKER_VERSION }}

      - name: show build Files
        run: ls

      - name: show artifacts
        run: | 
          cd artifacts
          ls
          cd ../

      - name: Unzip artifact
        uses: montudor/action-zip@v1
        with:
          args: unzip -qq artifacts/${{ env.ARTIFACT }} -d docs

      - name: show unzip Files
        run: ls

      - name: checkout docs
        run: cd docs

      - name: show docs Files
        run: ls

      - name: add dockerignore
        run: |
          cat >>.dockerignore <<END
          .idea
          .git
          Dockerfile
          .dockerignore
          END

      - name: add Dockerfile
        run: |
          cat >>Dockerfile <<END
          FROM nginx:1.23.1-alpine
          EXPOSE 80
          COPY default.conf /etc/nginx/conf.d/
          COPY . /docs/
          END

      - name: add default.conf
        run: |
          cat >>default.conf <<END
          server {
            listen 80;
            server_name localhost 127.0.0.1;
            location / {
              root /docs/;
            }
          }
          END
      - name: show docker config file
        run: ls

      - name: Log in to Docker Hub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
        with:
          images: docs/demo:latest

      - name: Build and push Docker image
        uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}


#      - name: Publish to Registry
#        # https://github.com/elgohr/Publish-Docker-Github-Action
#        uses: elgohr/Publish-Docker-Github-Action@v5
#        with:
#          name: docs/demo:latest
##          name: ${{ secrets.DOCKER_REGISTRY }}/njf/open-docs:latest
##          registry: ${{ secrets.DOCKER_REGISTRY }}
#          username: ${{ secrets.DOCKER_USERNAME }}
#          password: ${{ secrets.DOCKER_PASSWORD }}

#      - name: executing remote ssh commands using ssh key
#        uses: appleboy/ssh-action@v1.0.0
#        with:
#          host: ${{ secrets.TX_SSH_HOST }}
#          username: ${{ secrets.TX_SSH_USER }}
#          key: ${{ secrets.TX_SSH_KEY }}
#          script: |
#            cd /home/server/openDocs/
#            sh docker-compose-runner.sh

          
